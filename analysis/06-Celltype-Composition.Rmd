---
title: "Cell type composition analysis"
author: "Belinda Phipson"
date: "7/17/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE
)
```


# Introduction

I'm interested in having a look at the differences in broad cell type composition between the fetal, young, adult and DCM samples.

# Load libraries and functions

```{r}
library(edgeR)
library(RColorBrewer)
library(org.Hs.eg.db)
library(limma)
library(Seurat)
library(monocle)
library(cowplot)
library(DelayedArray)
library(scran)
library(NMF)
library(workflowr)
library(ggplot2)
library(clustree)
library(dplyr)
```

```{r}
source("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/code/normCounts.R")
source("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/code/findModes.R")
source("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/code/ggplotColors.R")
source("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/code/getTransformedProps.R")
```

# Read in the data objects

```{r readTargets}
targets <- read.delim("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/data/targets.txt",header=TRUE, stringsAsFactors = FALSE)
targets$FileName2 <- paste(targets$FileName,"/",sep="")
targets$Group_ID2 <- gsub("LV_","",targets$Group_ID)
group <- c("Fetal_1","Fetal_2","Fetal_3",
           "Young_1","Young_2","Young_3",
           "Adult_1","Adult_2","Adult_3", 
           "Diseased_1","Diseased_2",
           "Diseased_3","Diseased_4")
m <- match(group, targets$Group_ID2)
targets <- targets[m,]
```

```{r readData}
fetal.integrated <- readRDS(file="./output/RDataObjects/fetal-int.Rds")
load(file="./output/RDataObjects/fetalObjs.Rdata")

young.integrated <- readRDS(file="./output/RDataObjects/young-int.Rds")
load(file="./output/RDataObjects/youngObjs.Rdata")

adult.integrated <- readRDS(file="./output/RDataObjects/adult-int.Rds")
load(file="./output/RDataObjects/adultObjs.Rdata")


dcm.integrated <- readRDS(file="./output/RDataObjects/dcm-int.Rds")
load(file="./output/RDataObjects/dcmObjs.Rdata")
```

# Set default clustering resolution

```{r}
# Default 0.3
Idents(fetal.integrated) <- fetal.integrated$integrated_snn_res.0.3
DimPlot(fetal.integrated, reduction = "tsne",label=TRUE,label.size = 6)+NoLegend()

# Default 0.3
DimPlot(young.integrated, reduction = "tsne",label=TRUE,label.size = 6)+NoLegend()

# Default 0.6
DimPlot(adult.integrated, reduction = "tsne",label=TRUE,label.size = 6)+NoLegend()

# Default 0.3
Idents(dcm.integrated) <- dcm.integrated$integrated_snn_res.0.3
DimPlot(dcm.integrated, reduction = "tsne",label=TRUE,label.size = 6)+NoLegend()
```


# Assign cell types to clusters

```{r readClustCell}
f.clust <- read.delim("data/fetal-clust.txt",header=TRUE,nrow=22,stringsAsFactors = FALSE)
y.clust <- read.delim("data/young-clust.txt",header=TRUE,stringsAsFactors = FALSE)
a.clust <- read.delim("data/adult-clust.txt",header=TRUE,nrow=21,stringsAsFactors = FALSE)
d.clust <- read.delim("data/dcm-clust.txt",header=TRUE,nrow=17,stringsAsFactors = FALSE)
d.clust <- d.clust[,1:3]
```



```{r, fig.width=10,fig.height=10}
fetal.annot <- fetal.integrated
new.cluster.ids <- f.clust$Celltype
names(new.cluster.ids) <- levels(fetal.annot)
fetal.annot <- RenameIdents(fetal.annot, new.cluster.ids)
DimPlot(fetal.annot, reduction = "tsne", label = TRUE, pt.size = 0.5) + NoLegend()

fetal.broad <- fetal.integrated
broad.cluster.ids <- f.clust$Broad_celltype
names(broad.cluster.ids) <- levels(fetal.broad)
fetal.broad <- RenameIdents(fetal.broad, broad.cluster.ids)
DimPlot(fetal.broad, reduction = "tsne", label = TRUE, pt.size = 0.5, label.size = 6) + NoLegend()

fetal.integrated$Celltype <- Idents(fetal.annot)
fetal.integrated$Broad_celltype <- Idents(fetal.broad)
```

```{r, fig.width=10,fig.height=10}
young.annot <- young.integrated
new.cluster.ids <- y.clust$Celltype
names(new.cluster.ids) <- levels(young.annot)
young.annot <- RenameIdents(young.annot, new.cluster.ids)
DimPlot(young.annot, reduction = "tsne", label = TRUE, pt.size = 0.5) + NoLegend()

young.broad <- young.integrated
broad.cluster.ids <- y.clust$Broad_celltype
names(broad.cluster.ids) <- levels(young.broad)
young.broad <- RenameIdents(young.broad, broad.cluster.ids)
DimPlot(young.broad, reduction = "tsne", label = TRUE, pt.size = 0.5, label.size=6) + NoLegend()

young.integrated$Celltype <- Idents(young.annot)
young.integrated$Broad_celltype <- Idents(young.broad)
```

```{r, fig.width=10,fig.height=10}
adult.annot <- adult.integrated
new.cluster.ids <- a.clust$Celltype
names(new.cluster.ids) <- levels(adult.annot)
adult.annot <- RenameIdents(adult.annot, new.cluster.ids)
DimPlot(adult.annot, reduction = "tsne", label = TRUE, pt.size = 0.5) + NoLegend()

adult.broad <- adult.integrated
broad.cluster.ids <- a.clust$Broad_celltype
names(broad.cluster.ids) <- levels(adult.broad)
adult.broad <- RenameIdents(adult.broad, broad.cluster.ids)
DimPlot(adult.broad, reduction = "tsne", label = TRUE, pt.size = 0.5, label.size = 6) + NoLegend()

adult.integrated$Celltype <- Idents(adult.annot)
adult.integrated$Broad_celltype <- Idents(adult.broad)
```

```{r, fig.width=10,fig.height=10}
dcm.annot <- dcm.integrated
new.cluster.ids <- d.clust$Celltype
names(new.cluster.ids) <- levels(dcm.annot)
dcm.annot <- RenameIdents(dcm.annot, new.cluster.ids)
DimPlot(dcm.annot, reduction = "tsne", label = TRUE, pt.size = 0.5) + NoLegend()

dcm.broad <- dcm.integrated
broad.cluster.ids <- d.clust$Broad_celltype
names(broad.cluster.ids) <- levels(dcm.broad)
dcm.broad <- RenameIdents(dcm.broad, broad.cluster.ids)
DimPlot(dcm.broad, reduction = "tsne", label = TRUE, pt.size = 0.5, label.size = 6) + NoLegend()

dcm.integrated$Celltype <- Idents(dcm.annot)
dcm.integrated$Broad_celltype <- Idents(dcm.broad)
```

```{r}
pdf("./output/Figures/fetal-broad-celltypes-TSNE.pdf",width=7,height=7)
DimPlot(fetal.broad, reduction = "tsne", label = TRUE, pt.size = 0.5) + NoLegend() + ggtitle("Fetal samples")
dev.off()

pdf("./output/Figures/young-broad-celltypes-TSNE.pdf",width=7,height=7)
DimPlot(young.broad, reduction = "tsne", label = TRUE, pt.size = 0.5) + NoLegend() + ggtitle("Young samples")
dev.off()

pdf("./output/Figures/adult-broad-celltypes-TSNE.pdf",width=7,height=7)
DimPlot(adult.broad, reduction = "tsne", label = TRUE, pt.size = 0.5) + NoLegend() + ggtitle("Adult samples")
dev.off()

pdf("./output/Figures/dcm-broad-celltypes-TSNE.pdf",width=7,height=7)
DimPlot(dcm.broad, reduction = "tsne", label = TRUE, pt.size = 0.5) + NoLegend() + ggtitle("DCM samples")
dev.off()
```


# Get data into format for proportions analysis

```{r annprop}
allcells <- data.frame(Cellname=c(colnames(fetal.integrated),colnames(young.integrated),colnames(adult.integrated),colnames(dcm.integrated)),
                   Celltype = c(as.character(fetal.integrated$Celltype),as.character(young.integrated$Celltype),as.character(adult.integrated$Celltype),as.character(dcm.integrated$Celltype)),
                   Broad_celltype=c(as.character(fetal.integrated$Broad_celltype),as.character(young.integrated$Broad_celltype),as.character(adult.integrated$Broad_celltype),as.character(dcm.integrated$Broad_celltype)),
                   Sample =c(fetal.integrated$biorep,young.integrated$biorep,adult.integrated$biorep,dcm.integrated$biorep),
                   Group=rep(c("fetal","young","adult","dcm"),c(ncol(fetal.integrated),ncol(young.integrated),ncol(adult.integrated),ncol(dcm.integrated)))) 

allcells$Group <- factor(allcells$Group,levels=c("fetal","young","adult","dcm"))

cellfreq <- table(allcells$Broad_celltype,allcells$Sample)
props <-  t(t(cellfreq)/colSums(cellfreq))

group <- rep(c("adult","dcm","fetal","young"),c(3,4,3,3))
group <- factor(group,levels=c("fetal","young","adult","dcm"))
```

```{r}
par(mar=c(5,5,2,2))
props.group <- getTransformedProps(allcells$Broad_celltype,allcells$Group)
barplot(props.group$Proportions,col=ggplotColors(8),ylab="Cell type proportions",xlab="Group",cex.axis=1.5,cex.lab=1.5,cex.names = 1.5)

plot.new()
par(mar=c(1,1,1,1))
legend("topleft",legend=levels(allcells$Broad_celltype),fill=ggplotColors(8),cex=2)
```

# Test differences between groups using prop.table

```{r}
tab <- table(allcells$Broad_celltype,allcells$Group)
N <- colSums(tab)
pval.classic <- rep(NA,nrow(tab))
names(pval.classic) <- rownames(tab)
for(i in 1:nrow(tab)) pval.classic[i] <- prop.test(tab[i,],N)$p.value
fdr.classic <- p.adjust(pval.classic,method="BH")
```

# Test differences between two male samples with prop.table

```{r}
allcells$Sample <- factor(allcells$Sample,levels=c("f1","f2","f3","y1","y2","y3","a1","a2","a3","d1","d2","d3","d4"))
tabfm <- table(allcells$Broad_celltype,allcells$Sample)
N2 <- colSums(tabfm)
pval.male.classic <- rep(NA,nrow(tabfm))
names(pval.male.classic) <- rownames(tabfm)
for(i in 1:nrow(tabfm)) pval.male.classic[i] <- prop.test(tabfm[i,1:2],N2[1:2])$p.value
fdr.male.classic <- p.adjust(pval.male.classic,method="BH")
```

```{r}
prop.rep <- getTransformedProps(allcells$Broad_celltype,allcells$Sample)

par(mfrow=c(1,1))
avg.prop <- rowMeans(prop.rep$Proportions[,1:2])
o <- order(avg.prop,decreasing = TRUE)
barplot(t(prop.rep$Proportions[,1:2])[,o],beside=TRUE,las=2,col=ggplotColors(2),ylab="Proportion",cex.axis = 1.5,cex.lab=1.5,cex.names=1.5)
legend("topright",legend=c("Fetal Rep 1","Fetal Rep 2"),fill=ggplotColors(2),cex=1.5)
```


# Test for differences using propeller

```{r,fig.width=10,fig.height=10}
#allcells$Sample <- factor(allcells$Sample,levels=c("f1","f2","f3","y1","y2","y3","a1","a2","a3","d1","d2","d3","d4"))

barplot(prop.rep$Proportions,col=ggplotColors(8),ylab="Cell type proportions",xlab="Group",cex.axis=1.5,cex.lab=1.5,cex.names = 1.5)

targets$Group <- factor(targets$Group,levels=c("Fetal","Child","Adult","DCM"))

par(mar=c(4,5,2,2))
stripchart(prop.rep$Proportions[3,]~targets$Group,method="jitter",vertical=TRUE,pch=16,col=ggplotColors(4),cex=2,
           ylab="Estimated proportions",main=rownames(prop.rep$Proportions)[3], cex.axis=1.5,cex.lab=1.5,cex.main=2)

par(mfrow=c(3,3))
for(i in 1:8){
plot(jitter(as.numeric(targets$Group)),prop.rep$Proportions[i,],xaxt="n",xlab="",xlim=c(0.5,4.5),col=ggplotColors(4)[factor(targets$Group)],pch=c(8,16)[factor(targets$Sex)],cex=2,ylab="Estimated proportions",main=rownames(prop.rep$Proportions)[i],cex.axis=1.5,cex.lab=1.5,cex.main=2)
axis(side=1,at = 1:4, labels = levels(targets$Group),cex.axis=1.5)
#legend("topleft",legend=levels(factor(targets$Sex)),pch=c(8,16),cex=1.5)
}
```



# Test for differences in cell type proportions

```{r propTest}
design <- model.matrix(~targets$Sex + targets$Group)

fit <- lmFit(prop.rep$TransformedProps,design)
fit <- eBayes(fit[,-c(1:2)],trend=TRUE)

summary(decideTests(fit))

top <- topTable(fit)
```

```{r}
options(digits = 3)
top
```


```{r,fig.width=10,fig.height=10}
sig.ct <- rownames(top)
par(mfrow=c(3,3))
for(i in 1:nrow(prop.rep$Proportions)){
 stripchart(prop.rep$TransformedProps[sig.ct[i],]~targets$Group,method="jitter",vertical=TRUE,pch=16,col=ggplotColors(4),cex=1.5,
           ylab="Asin(sqrt(prop))",main=sig.ct[i])
}

```

```{r,fig.width=10,fig.height=10}
par(mar=c(7,5,3,2))
par(mfrow=c(3,3))
barplot(table(allcells$Broad_celltype)/sum(table(allcells$Broad_celltype)),las=2,main="Background proportions",
        col=c(2,"grey","grey",2,2,2,"grey",2),ylab="Proportion",cex.lab=1.5,cex.axis=1.5,cex.main=2)
legend("topright",fill=c(2,"grey"),legend=c("adj.P<0.05","ns"))
par(mar=c(4,5,3,2))
for(i in 1:nrow(prop.rep$Proportions)){
 stripchart(prop.rep$Proportions[sig.ct[i],]~targets$Group,method="jitter",vertical=TRUE,pch=16,col=ggplotColors(4),cex=2,
           ylab="Estimated proportions",main=sig.ct[i],cex.axis=1.5,cex.lab=1.5,cex.main=2)
}

```

```{r,fig.width=10,fig.height=10}
par(mar=c(8,5,3,2))
par(mfrow=c(3,3))
barplot(sort(table(allcells$Broad_celltype)/sum(table(allcells$Broad_celltype)),decreasing=TRUE),
        las=2,main="Average proportions",ylab="Proportion",cex.lab=1.5,cex.axis=1.5,cex.main=2,
        col=c(2,2,"grey",2,"grey","grey",2,2))
legend("topright",fill=c(2,"grey"),legend=c("adj.P<0.05","ns"),cex=1.5)
par(mar=c(4,5,3,2))
plot(jitter(as.numeric(targets$Group)),prop.rep$Proportions[sig.ct[1],],xaxt="n",xlab="",xlim=c(0.5,4.5),col=ggplotColors(4)[factor(targets$Group)],pch=c(8,16)[factor(targets$Sex)],cex=2,ylab="Estimated proportions",main=sig.ct[1],cex.axis=1.5,cex.lab=1.5,cex.main=2)
axis(side=1,at = 1:4, labels = levels(targets$Group),cex.axis=1.5)
legend("topright",legend=levels(factor(targets$Sex)),pch=c(8,16),cex=1.5)
for(i in 2:8){
plot(jitter(as.numeric(targets$Group)),prop.rep$Proportions[sig.ct[i],],xaxt="n",xlab="",xlim=c(0.5,4.5),col=ggplotColors(4)[factor(targets$Group)],pch=c(8,16)[factor(targets$Sex)],cex=2,ylab="Estimated proportions",main=sig.ct[i],cex.axis=1.5,cex.lab=1.5,cex.main=2)
axis(side=1,at = 1:4, labels = levels(targets$Group),cex.axis=1.5)
#legend("topleft",legend=levels(factor(targets$Sex)),pch=c(8,16),cex=1.5)
}
```

```{r}
par(mfrow=c(1,2))
plot(jitter(as.numeric(targets$Group)),prop.rep$Proportions["Erythroid",],xaxt="n",xlab="",xlim=c(0.5,4.5),col=ggplotColors(4)[factor(targets$Group)],pch=c(8,16)[factor(targets$Sex)],cex=2,ylab="Estimated proportions",main="Erythroid",cex.axis=1.5,cex.lab=1.5,cex.main=2)
legend("topright",legend=levels(factor(targets$Sex)),pch=c(8,16),cex=1.5)
axis(side=1,at = 1:4, labels = levels(targets$Group),cex.axis=1.5)

plot(jitter(as.numeric(targets$Group)),prop.rep$Proportions["Immune cells",],xaxt="n",xlab="",xlim=c(0.5,4.5),col=ggplotColors(4)[factor(targets$Group)],pch=c(8,16)[factor(targets$Sex)],cex=2,ylab="Estimated proportions",main="Immune cells",cex.axis=1.5,cex.lab=1.5,cex.main=2)
axis(side=1,at = 1:4, labels = levels(targets$Group),cex.axis=1.5)
```


# Save objects with new cluster annotation

```{r}
#saveRDS(fetal.integrated, file="./output/RDataObjects/fetal-int.Rds")

#saveRDS(young.integrated, file="./output/RDataObjects/young-int.Rds")

#saveRDS(adult.integrated, file="./output/RDataObjects/adult-int.Rds")

#saveRDS(dcm.integrated, file="./output/RDataObjects/dcm-int.Rds")

```



