---
title: "Marker analysis of broad cell types"
author: "Belinda Phipson"
date: "1/31/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE
)
```


# Introduction

I'm interested in having a look at the differences in broad cell type composition between the fetal, young, adult and DCM samples.

# Load libraries and functions

```{r}
library(edgeR)
library(RColorBrewer)
library(org.Hs.eg.db)
library(limma)
library(Seurat)
library(monocle)
library(cowplot)
library(DelayedArray)
library(scran)
library(NMF)
library(workflowr)
library(ggplot2)
library(clustree)
library(dplyr)
library(gridBase)
library(grid)
```

```{r}
source("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/code/normCounts.R")
source("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/code/findModes.R")
source("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/code/ggplotColors.R")
source("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/code/getTransformedProps.R")
```

# Read in the data objects

```{r readTargets}
targets <- read.delim("/misc/card2-single_cell_nuclei_rnaseq/Porello-heart-snRNAseq/data/targets.txt",header=TRUE, stringsAsFactors = FALSE)
targets$FileName2 <- paste(targets$FileName,"/",sep="")
targets$Group_ID2 <- gsub("LV_","",targets$Group_ID)
group <- c("Fetal_1","Fetal_2","Fetal_3",
           "Young_1","Young_2","Young_3",
           "Adult_1","Adult_2","Adult_3", 
           "Diseased_1","Diseased_2",
           "Diseased_3","Diseased_4")
m <- match(group, targets$Group_ID2)
targets <- targets[m,]
```

```{r readData}
fetal.integrated <- readRDS(file="./output/RDataObjects/fetal-int.Rds")
load(file="./output/RDataObjects/fetalObjs.Rdata")

young.integrated <- readRDS(file="./output/RDataObjects/young-int.Rds")
load(file="./output/RDataObjects/youngObjs.Rdata")

adult.integrated <- readRDS(file="./output/RDataObjects/adult-int.Rds")
load(file="./output/RDataObjects/adultObjs.Rdata")

# Load unfiltered counts matrix for every sample (object all)
load("./output/RDataObjects/all-counts.Rdata")

# Load C2 gene setÃŸ
load("./output/RDataObjects/human_c2_v5p2.rdata")
```

# Set default clustering resolution

```{r}
# Default 0.3
Idents(fetal.integrated) <- fetal.integrated$integrated_snn_res.0.3
#DimPlot(fetal.integrated, reduction = "tsne",label=TRUE,label.size = 6)+NoLegend()

# Default 0.3
#DimPlot(young.integrated, reduction = "tsne",label=TRUE,label.size = 6)+NoLegend()

# Default 0.6
#DimPlot(adult.integrated, reduction = "tsne",label=TRUE,label.size = 6)+NoLegend()

# Default 0.3
#Idents(dcm.integrated) <- dcm.integrated$integrated_snn_res.0.3
#DimPlot(dcm.integrated, reduction = "tsne",label=TRUE,label.size = 6)+NoLegend()
```


```{r}
#load(file="./output/RDataObjects/counts-filtered.Rdata")
```

# Fetal broad cell type markers

```{r}
m <- match(colnames(fetal.integrated),colnames(all))
fetal.counts <- all[,m]
```

## Get gene annotation and perform filtering
```{r}
columns(org.Hs.eg.db)
ann <- AnnotationDbi:::select(org.Hs.eg.db,keys=rownames(fetal.counts),columns=c("SYMBOL","ENTREZID","ENSEMBL","GENENAME","CHR"),keytype = "SYMBOL")
m <- match(rownames(fetal.counts),ann$SYMBOL)
ann <- ann[m,]
table(ann$SYMBOL==rownames(fetal.counts))
```

```{r}
mito <- grep("mitochondrial",ann$GENENAME)
length(mito)
ribo <- grep("ribosomal",ann$GENENAME)
length(ribo)
missingEZID <- which(is.na(ann$ENTREZID))
length(missingEZID)
```

```{r}
chuck <- unique(c(mito,ribo,missingEZID))
length(chuck)
fetal.counts.keep <- fetal.counts[-chuck,]
ann.keep <- ann[-chuck,]
table(ann.keep$SYMBOL==rownames(fetal.counts.keep))
```

```{r}
numzero.genes <- rowSums(fetal.counts.keep==0)
table(numzero.genes > (ncol(fetal.counts.keep)-20))
keep.genes <- numzero.genes < (ncol(fetal.counts.keep)-20)
table(keep.genes)
fetal.keep <- fetal.counts.keep[keep.genes,]
dim(fetal.keep)
ann.keep.fetal <- ann.keep[keep.genes,]
```

## Limma analysis
```{r}
y.fetal <- DGEList(fetal.keep)

logcounts.fetal <- normCounts(y.fetal,log=TRUE,prior.count=0.5)

fetal.bct <- factor(fetal.integrated$Broad_celltype,
              levels=c("Cardiomyocytes","Fibroblast","Endothelial cells",
                       "Immune cells","Epicardial cells","Neurons",
                       "Smooth muscle cells","Erythroid"))

fetal.integrated$Broad_celltype <- factor(fetal.integrated$Broad_celltype,
              levels=c("Cardiomyocytes","Fibroblast","Endothelial cells",
                       "Immune cells","Epicardial cells","Neurons",
                       "Smooth muscle cells","Erythroid"))

design <- model.matrix(~0+fetal.bct+fetal.integrated$biorep)
colnames(design)[1:(length(levels(fetal.bct)))] <- levels(fetal.bct)

mycont <- matrix(0,ncol=length(levels(fetal.bct)),nrow=length(levels(fetal.bct)))
colnames(mycont)<-levels(fetal.bct)
diag(mycont)<-1
mycont[upper.tri(mycont)]<- -1/(length(levels(fetal.bct))-1)
mycont[lower.tri(mycont)]<- -1/(length(levels(fetal.bct))-1)

# Fill out remaining rows with 0s
zero.rows <- matrix(0,ncol=length(levels(fetal.bct)),nrow=(ncol(design)-length(levels(fetal.bct))))
test <- rbind(mycont,zero.rows)


fit <- lmFit(logcounts.fetal,design)
fit.cont <- contrasts.fit(fit,contrasts=test)
fit.cont <- eBayes(fit.cont,trend=TRUE,robust=TRUE)

fit.cont$genes <- ann.keep.fetal

summary(decideTests(fit.cont))

treat <- treat(fit.cont,lfc=0.5)

dt <- decideTests(treat)
summary(dt)

```

```{r}
treat.fetal <- treat
save(treat.fetal,file="./output/RDataObjects/bct-treat-fetal.RData")
```


```{r,fig.width=10,fig.height=10}
par(mar=c(5,5,2,2))
par(mfrow=c(3,3))
for(i in 1:ncol(mycont)){
  plotMD(treat,coef=i,status = dt[,i],hl.cex=0.5)
  abline(h=0,col=colours()[c(226)])
  lines(lowess(treat$Amean,treat$coefficients[,i]),lwd=1.5,col=4)
}
```

### Write out marker genes for each cluster

```{r eval=FALSE}
contnames <- colnames(mycont)

for(i in 1:length(contnames)){
  topsig <- topTreat(treat,coef=i,n=Inf,sort.by = "t")
  write.csv(topsig,file=paste("./output/ForPaper/BroadCellTypeMarkers/Fetal-MarkerAnalysis/Fetal-",contnames[i],".csv",sep=""))
}
```

```{r}
fdr <- apply(treat$p.value, 2, function(x) p.adjust(x, method="BH"))
output <- data.frame(treat$genes,LogFC=treat$coefficients,AveExp=treat$Amean,tstat=treat$t, pvalue=treat$p.value, fdr=fdr)
write.csv(output,file="./output/ForPaper/BroadCellTypeMarkers/Fetal-MarkerAnalysis/FetalMarkerAnalysis.csv")
```

## Visualise some marker genes

### DotPlot to visualise marker genes in fetal
```{r}
DefaultAssay(fetal.integrated) <- "RNA"

sig.genes <- gene.label <- vector("list", length(contnames))
for(i in 1:length(sig.genes)){
  top <- topTreat(treat,coef=i,n=Inf,sort.by="t")
  sig.genes[[i]] <- rownames(top)[top$logFC>0][1:10]
  gene.label[[i]] <- paste(rownames(top)[top$logFC>0][1:10],contnames[i],sep="-")
} 

csig <- unlist(sig.genes)
genes <- unlist(gene.label)

missing <- is.na(match(csig,rownames(fetal.integrated)))

csig2 <- csig[!missing]

gene.cols <- rep(c(ggplotColors(7),"grey"),each=10)
gene.cols <- gene.cols[!missing]

d <- duplicated(csig2)
csig2 <- csig2[!d]
gene.cols <- gene.cols[!d]
```

```{r}
DotPlot(fetal.integrated,features=csig2,group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 11, x.text=18) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))
```


```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/Fetal-DotPlotMarkers.pdf",width=7,height=11)
DotPlot(fetal.integrated,features=csig2,group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 11, x.text=18) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))
dev.off()
```


```{r}

topsig <- rownames(topTreat(treat,coef=1,sort.by = "t"))
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/cardio-markers-vlnplot1-5.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[1:5],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/cardio-markers-vlnplot6-10.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[6:10],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/cardio-markers-vlnplot1-3.pdf",width=8,height=15)
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

```

```{r}
topsig <- rownames(topTreat(treat,coef=2,sort.by = "t"))
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fibro-markers-vlnplot1-5.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[1:5],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fibro-markers-vlnplot6-10.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[6:10],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fibro-markers-vlnplot1-3.pdf",width=8,height=15)
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()
```

```{r}
topsig <- rownames(topTreat(treat,coef=3,sort.by = "t"))
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/endo-markers-vlnplot1-5.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[1:5],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/endo-markers-vlnplot6-10.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[6:10],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/endo-markers-vlnplot1-3.pdf",width=8,height=15)
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()
```

```{r}
topsig <- rownames(topTreat(treat,coef=4,sort.by = "t"))
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/immune-markers-vlnplot1-5.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[1:5],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/immune-markers-vlnplot6-10.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[6:10],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/immune-markers-vlnplot1-3.pdf",width=8,height=15)
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()
```

```{r}
topsig <- rownames(topTreat(treat,coef=5,sort.by = "t"))
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/epi-markers-vlnplot1-5.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[1:5],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/epi-markers-vlnplot6-10.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[6:10],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/epi-markers-vlnplot1-3.pdf",width=8,height=15)
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()
```

```{r}
topsig <- rownames(topTreat(treat,coef=6,sort.by = "t"))
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/neurons-markers-vlnplot1-5.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[1:5],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/neurons-markers-vlnplot6-10.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[6:10],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/neurons-markers-vlnplot1-3.pdf",width=8,height=15)
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()
```

```{r}
topsig <- rownames(topTreat(treat,coef=7,sort.by = "t"))
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/smc-markers-vlnplot1-5.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[1:5],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/smc-markers-vlnplot6-10.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[6:10],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/smc-markers-vlnplot1-3.pdf",width=8,height=15)
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()
```

```{r}
topsig <- rownames(topTreat(treat,coef=8,sort.by = "t"))
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/eryth-markers-vlnplot1-5.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[1:5],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/eryth-markers-vlnplot6-10.pdf",width=8,height=20)
VlnPlot(fetal.integrated,features=topsig[6:10],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()

pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/eryth-markers-vlnplot1-3.pdf",width=8,height=15)
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
dev.off()
```
# Check progesterone receptor

```{r}
#ENSG00000082175 progesterone receptor
VlnPlot(fetal.integrated,features=topsig[1:3],group.by="Broad_celltype",cols=c(ggplotColors(7),"grey"),pt.size=0,ncol=1,log=TRUE)
```

## Perform gene set testing on reactome sets

```{r}
contnames <- colnames(mycont)

c2.id <- ids2indices(Hs.c2,treat$genes$ENTREZID)
reactome.id <-c2.id[grep("REACTOME",names(c2.id))]

reactome.cardio <- cameraPR(treat$t[,1],reactome.id)

for(i in 1:length(contnames)){
  write.csv(cameraPR(treat$t[,i],reactome.id),file=paste("./output/ForPaper/BroadCellTypeMarkers/Fetal-MarkerAnalysis/fetal-reactome-",contnames[i],".csv",sep=""))
}
```

### Reactome figures - cardio
```{r}
cardio.camera <- cameraPR(treat$t[,1],reactome.id)
cardio.camera.up <- cardio.camera[cardio.camera[,2]=="Up",]

fibro.camera <- cameraPR(treat$t[,2],reactome.id)
fibro.camera.up <- fibro.camera[fibro.camera[,2]=="Up",]

endo.camera <- cameraPR(treat$t[,3],reactome.id)
endo.camera.up <- endo.camera[endo.camera[,2]=="Up",]

immune.camera <- cameraPR(treat$t[,4],reactome.id)
immune.camera.up <- immune.camera[immune.camera[,2]=="Up",]

epic.camera <- cameraPR(treat$t[,5],reactome.id)
epic.camera.up <- epic.camera[epic.camera[,2]=="Up",]

neuron.camera <- cameraPR(treat$t[,6],reactome.id)
neuron.camera.up <- neuron.camera[neuron.camera[,2]=="Up",]

smc.camera <- cameraPR(treat$t[,7],reactome.id)
smc.camera.up <- smc.camera[smc.camera[,2]=="Up",]

eryth.camera <- cameraPR(treat$t[,8],reactome.id)
eryth.camera.up <- eryth.camera[eryth.camera[,2]=="Up",]

nsets <- 5
all.cam.fetal <- rbind(cardio.camera.up[1:nsets,], fibro.camera.up[1:nsets,],
                       endo.camera.up[1:nsets,],immune.camera.up[1:nsets,],
                       epic.camera.up[1:nsets,],neuron.camera.up[1:nsets,],
                       smc.camera.up[1:nsets,],eryth.camera.up[1:nsets,])

scores <- -log10(all.cam.fetal$PValue)
names(scores) <- rownames(all.cam.fetal)
names(scores) <- gsub("REACTOME_","",names(scores))


par(mfrow=c(1,1))
par(mar=c(5,40,3,2))
barplot(scores[(length(scores)-1):1],horiz = T,las=2,col=rev(rep(c(ggplotColors(7),"grey"),each=nsets)),cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Fetal - reactome sets",cex.main=2)
legend("topright",legend=levels(fetal.integrated$Broad_celltype),fill=c(ggplotColors(7),"grey"),cex=1.35,bty="n")
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-all-top3-barplot.pdf",width=12,height=6)
par(mfrow=c(1,1))
par(mar=c(5,44,3,2))
barplot(scores[length(scores):1],horiz = T,las=2,col=rev(rep(c(ggplotColors(7),"grey"),each=3)),cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Fetal - reactome sets",cex.main=2)
dev.off()
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/test-fetal.pdf",width=19,height=11, onefile = FALSE)
plot.new()
grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 2)))

aggplot <- DotPlot(fetal.integrated,features=csig2,group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 11, x.text=18) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))

#Draw ggplot
pushViewport(viewport(layout.pos.col = 2))
print(aggplot, newpage = FALSE)
popViewport()

bar.cols <- rev(rep(c(ggplotColors(7),"grey"),each=nsets))
        
#Draw bsae plot
pushViewport(viewport(layout.pos.col = 1))
par(fig = gridFIG(), new = TRUE)
par(mar=c(10,39,0,1))
par(mgp=c(4,1,0))
barplot(scores[(length(scores)-1):1],horiz = T,las=2,col=bar.cols[-1],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
popViewport()

dev.off()
```


###Reactome figures - cardio
```{r}
cardio.camera <- cameraPR(treat$t[,1],reactome.id)
cardio.camera.up <- cardio.camera[cardio.camera[,2]=="Up",]

scores <- -log10(cardio.camera.up$PValue)[1:10]
names(scores) <- rownames(cardio.camera.up)[1:10]

par(mar=c(5,35,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[1],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Cardiomyocytes",cex.main=2)
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-cardio-barplot.pdf",width=10,height=5)
par(mar=c(5,35,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[1],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Cardiomyocytes",cex.main=2)
dev.off()
```

###Reactome figures - fibro
```{r}
fibro.camera <- cameraPR(treat$t[,2],reactome.id)
fibro.camera.up <- fibro.camera[fibro.camera[,2]=="Up",]

scores <- -log10(fibro.camera.up$PValue)[1:10]
names(scores) <- rownames(fibro.camera.up)[1:10]

par(mar=c(5,35,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[2],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Fibroblasts",cex.main=2)
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-fibro-barplot.pdf",width=10,height=5)
par(mar=c(5,37,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[2],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Fibroblasts",cex.main=2)
dev.off()
```


###Reactome figures - endo
```{r}
endo.camera <- cameraPR(treat$t[,3],reactome.id)
endo.camera.up <- endo.camera[endo.camera[,2]=="Up",]

scores <- -log10(endo.camera.up$PValue)[1:10]
names(scores) <- rownames(endo.camera.up)[1:10]

par(mar=c(5,35,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[3],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Endothelial cells",cex.main=2)
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-endo-barplot.pdf",width=10,height=5)
par(mar=c(5,30,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[3],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Endothelial cells",cex.main=2)
dev.off()
```

###Reactome figures - immune
```{r}
immune.camera <- cameraPR(treat$t[,4],reactome.id)
immune.camera.up <- immune.camera[immune.camera[,2]=="Up",]

scores <- -log10(immune.camera.up$PValue)[1:10]
names(scores) <- rownames(immune.camera.up)[1:10]

par(mar=c(5,38,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[4],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Immune cells",cex.main=2)
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-immune-barplot.pdf",width=12,height=5)
par(mar=c(5,44,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[4],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Immune cells",cex.main=2)
dev.off()
```

###Reactome figures - epicardial
```{r}
epic.camera <- cameraPR(treat$t[,5],reactome.id)
epic.camera.up <- epic.camera[epic.camera[,2]=="Up",]

scores <- -log10(epic.camera.up$PValue)[1:10]
names(scores) <- rownames(epic.camera.up)[1:10]

par(mar=c(5,38,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[5],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Epicardial cells",cex.main=2)
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-epic-barplot.pdf",width=10,height=5)
par(mar=c(5,30,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[5],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Epicardial cells",cex.main=2)
dev.off()
```

###Reactome figures - neurons
```{r}
neur.camera <- cameraPR(treat$t[,6],reactome.id)
neur.camera.up <- neur.camera[neur.camera[,2]=="Up",]

scores <- -log10(neur.camera.up$PValue)[1:10]
names(scores) <- rownames(neur.camera.up)[1:10]

par(mar=c(5,35,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[6],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Neurons",cex.main=2)
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-neurons-barplot.pdf",width=10,height=5)
par(mar=c(5,35,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[5],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Neurons",cex.main=2)
dev.off()
```

###Reactome figures - smooth muscle cells
```{r}
smc.camera <- cameraPR(treat$t[,7],reactome.id)
smc.camera.up <- smc.camera[smc.camera[,2]=="Up",]

scores <- -log10(smc.camera.up$PValue)[1:10]
names(scores) <- rownames(smc.camera.up)[1:10]

par(mar=c(5,35,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[7],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Smooth muscle cells",cex.main=2)
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-smc-barplot.pdf",width=13,height=5)
par(mar=c(5,46,3,2))
barplot(scores[10:1],horiz = T,las=2,col=ggplotColors(7)[7],cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Smooth muscle cells",cex.main=2)
dev.off()
```

###Reactome figures - erythroid
```{r}
eryt.camera <- cameraPR(treat$t[,8],reactome.id)
eryt.camera.up <- eryt.camera[eryt.camera[,2]=="Up",]

scores <- -log10(eryt.camera.up$PValue)[1:10]
names(scores) <- rownames(eryt.camera.up)[1:10]

par(mar=c(5,35,3,2))
barplot(scores[10:1],horiz = T,las=2,col="grey",cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Erythroid cells",cex.main=2)
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Fetal/fetal-reactome-eryt-barplot.pdf",width=14,height=5)
par(mar=c(5,55,3,2))
barplot(scores[10:1],horiz = T,las=2,col="grey",cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Erythroid cells",cex.main=2)
dev.off()
```




# Young broad cell type markers

```{r}
m <- match(colnames(young.integrated),colnames(all))
young.counts <- all[,m]
```

## Get gene annotation and perform filtering
```{r}
columns(org.Hs.eg.db)
ann <- AnnotationDbi:::select(org.Hs.eg.db,keys=rownames(young.counts),columns=c("SYMBOL","ENTREZID","ENSEMBL","GENENAME","CHR"),keytype = "SYMBOL")
m <- match(rownames(young.counts),ann$SYMBOL)
ann <- ann[m,]
table(ann$SYMBOL==rownames(young.counts))
```

```{r}
mito <- grep("mitochondrial",ann$GENENAME)
length(mito)
ribo <- grep("ribosomal",ann$GENENAME)
length(ribo)
missingEZID <- which(is.na(ann$ENTREZID))
length(missingEZID)
```

```{r}
chuck <- unique(c(mito,ribo,missingEZID))
length(chuck)
young.counts.keep <- young.counts[-chuck,]
ann.keep <- ann[-chuck,]
table(ann.keep$SYMBOL==rownames(young.counts.keep))
```

```{r}
numzero.genes <- rowSums(young.counts.keep==0)
table(numzero.genes > (ncol(young.counts.keep)-20))
keep.genes <- numzero.genes < (ncol(young.counts.keep)-20)
table(keep.genes)
young.keep <- young.counts.keep[keep.genes,]
dim(young.keep)
ann.keep.young <- ann.keep[keep.genes,]
```

## Limma analysis
```{r}
y.young <- DGEList(young.keep)

logcounts.young <- normCounts(y.young,log=TRUE,prior.count=0.5)

young.bct <- factor(young.integrated$Broad_celltype,
              levels=c("Cardiomyocytes","Fibroblast","Endothelial cells",
                       "Immune cells","Epicardial cells","Neurons",
                       "Smooth muscle cells"))

young.integrated$Broad_celltype <- factor(young.integrated$Broad_celltype,
              levels=c("Cardiomyocytes","Fibroblast","Endothelial cells",
                       "Immune cells","Epicardial cells","Neurons",
                       "Smooth muscle cells"))

design <- model.matrix(~0+young.bct+young.integrated$biorep)
colnames(design)[1:(length(levels(young.bct)))] <- levels(young.bct)

mycont <- matrix(0,ncol=length(levels(young.bct)),nrow=length(levels(young.bct)))
colnames(mycont)<-levels(young.bct)
diag(mycont)<-1
mycont[upper.tri(mycont)]<- -1/(length(levels(young.bct))-1)
mycont[lower.tri(mycont)]<- -1/(length(levels(young.bct))-1)

# Fill out remaining rows with 0s
zero.rows <- matrix(0,ncol=length(levels(young.bct)),nrow=(ncol(design)-length(levels(young.bct))))
test <- rbind(mycont,zero.rows)


fit <- lmFit(logcounts.young,design)
fit.cont <- contrasts.fit(fit,contrasts=test)
fit.cont <- eBayes(fit.cont,trend=TRUE,robust=TRUE)

fit.cont$genes <- ann.keep.young

summary(decideTests(fit.cont))

treat <- treat(fit.cont,lfc=0.5)

dt <- decideTests(treat)
summary(dt)

```
```{r}
treat.young <- treat
save(treat.young,file="./output/RDataObjects/bct-treat-young.RData")
```

```{r,fig.width=10,fig.height=10}
par(mfrow=c(3,3))
for(i in 1:ncol(mycont)){
  plotMD(treat,coef=i,status = dt[,i],hl.cex=0.5)
  abline(h=0,col=colours()[c(226)])
  lines(lowess(treat$Amean,treat$coefficients[,i]),lwd=1.5,col=4)
}
```

### Write out marker genes for each cluster

```{r eval=FALSE}
contnames <- colnames(mycont)

for(i in 1:length(contnames)){
  topsig <- topTreat(treat,coef=i,n=Inf,sort.by = "t")
  write.csv(topsig,file=paste("./output/ForPaper/BroadCellTypeMarkers/Young-MarkerAnalysis/Young-",contnames[i],".csv",sep=""))
}
```

```{r}
fdr <- apply(treat$p.value, 2, function(x) p.adjust(x, method="BH"))
output <- data.frame(treat$genes,LogFC=treat$coefficients,AveExp=treat$Amean,tstat=treat$t, pvalue=treat$p.value, fdr=fdr)
write.csv(output,file="./output/ForPaper/BroadCellTypeMarkers/Young-MarkerAnalysis/YoungMarkerAnalysis.csv")
```

### DotPlot to visualise marker genes in young
```{r}
DefaultAssay(young.integrated) <- "RNA"

sig.genes <- gene.label <- vector("list", length(contnames))
for(i in 1:length(sig.genes)){
  top <- topTreat(treat.young,coef=i,n=Inf,sort.by="t")
  sig.genes[[i]] <- rownames(top)[top$logFC>0][1:10]
  gene.label[[i]] <- paste(rownames(top)[top$logFC>0][1:10],contnames[i],sep="-")
} 

csig <- unlist(sig.genes)
genes <- unlist(gene.label)

missing <- is.na(match(csig,rownames(young.integrated)))

csig2 <- csig[!missing]

gene.cols <- rep(c(ggplotColors(7)),each=10)
gene.cols <- gene.cols[!missing]

d <- duplicated(csig2)
csig2 <- csig2[!d]
gene.cols <- gene.cols[!d]
```

```{r}
DotPlot(young.integrated,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))

```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Young/young-DotPlotMarkers.pdf",width=7,height=12)
DotPlot(young.integrated,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))
dev.off()
```

## Perform gene set testing on reactome sets

```{r}
c2.id <- ids2indices(Hs.c2,treat$genes$ENTREZID)
reactome.id <-c2.id[grep("REACTOME",names(c2.id))]

reactome.cardio <- cameraPR(treat$t[,1],reactome.id)

for(i in 1:length(contnames)){
  write.csv(cameraPR(treat$t[,i],reactome.id),file=paste("./output/ForPaper/BroadCellTypeMarkers/Young-MarkerAnalysis/young-reactome-",contnames[i],".csv",sep=""))
}
```

### Reactome barplot figure - young 
```{r}
cardio.camera <- cameraPR(treat$t[,1],reactome.id)
cardio.camera.up <- cardio.camera[cardio.camera[,2]=="Up",]

fibro.camera <- cameraPR(treat$t[,2],reactome.id)
fibro.camera.up <- fibro.camera[fibro.camera[,2]=="Up",]

endo.camera <- cameraPR(treat$t[,3],reactome.id)
endo.camera.up <- endo.camera[endo.camera[,2]=="Up",]

immune.camera <- cameraPR(treat$t[,4],reactome.id)
immune.camera.up <- immune.camera[immune.camera[,2]=="Up",]

epic.camera <- cameraPR(treat$t[,5],reactome.id)
epic.camera.up <- epic.camera[epic.camera[,2]=="Up",]

neuron.camera <- cameraPR(treat$t[,6],reactome.id)
neuron.camera.up <- neuron.camera[neuron.camera[,2]=="Up",]

smc.camera <- cameraPR(treat$t[,7],reactome.id)
smc.camera.up <- smc.camera[smc.camera[,2]=="Up",]

nsets <- 5
all.cam.young <- rbind(cardio.camera.up[1:nsets,], fibro.camera.up[1:nsets,],
                       endo.camera.up[1:nsets,],immune.camera.up[1:nsets,],
                       epic.camera.up[1:nsets,],neuron.camera.up[1:nsets,],
                       smc.camera.up[1:nsets,])

scores <- -log10(all.cam.young$PValue)
names(scores) <- rownames(all.cam.young)
names(scores) <- gsub("REACTOME_","",names(scores))

par(mfrow=c(1,1))
par(mar=c(5,40,3,2))
barplot(scores[length(scores):1],horiz = T,las=2,col=rev(rep(ggplotColors(7),each=nsets)),cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Fetal - reactome sets",cex.main=2)
legend("topright",legend=levels(fetal.integrated$Broad_celltype),fill=c(ggplotColors(7),"grey"),cex=1.35,bty="n")
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Young/young-reactome-all-top-barplot.pdf",width=10,height=10)
par(mfrow=c(1,1))
par(mar=c(5,40,3,2))
barplot(scores[length(scores):1],horiz = T,las=2,col=rev(rep(ggplotColors(7),each=nsets)),cex.names=0.9,
        cex.axis = 1.4,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
title("Young - reactome sets",cex.main=2)
dev.off()
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Young/test-young.pdf",width=19,height=11, onefile = FALSE)
plot.new()
grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 2)))

aggplot <- DotPlot(young.integrated,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))

#Draw ggplot
pushViewport(viewport(layout.pos.col = 2))
print(aggplot, newpage = FALSE)
popViewport()

#Draw bsae plot
pushViewport(viewport(layout.pos.col = 1))
par(fig = gridFIG(), new = TRUE)
par(mar=c(10,38,0,1))
par(mgp=c(4,1,0))
barplot(scores[length(scores):1],horiz = T, las=2,col=rev(rep(ggplotColors(7),each=nsets)),cex.names=0.8,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
popViewport()

dev.off()
```


# Adult broad cell type markers

```{r}
m <- match(colnames(adult.integrated),colnames(all))
adult.counts <- all[,m]
```

## Get gene annotation and perform filtering
```{r}
columns(org.Hs.eg.db)
ann <- AnnotationDbi:::select(org.Hs.eg.db,keys=rownames(adult.counts),columns=c("SYMBOL","ENTREZID","ENSEMBL","GENENAME","CHR"),keytype = "SYMBOL")
m <- match(rownames(adult.counts),ann$SYMBOL)
ann <- ann[m,]
table(ann$SYMBOL==rownames(adult.counts))
```

```{r}
mito <- grep("mitochondrial",ann$GENENAME)
length(mito)
ribo <- grep("ribosomal",ann$GENENAME)
length(ribo)
missingEZID <- which(is.na(ann$ENTREZID))
length(missingEZID)
```

```{r}
chuck <- unique(c(mito,ribo,missingEZID))
length(chuck)
adult.counts.keep <- adult.counts[-chuck,]
ann.keep <- ann[-chuck,]
table(ann.keep$SYMBOL==rownames(adult.counts.keep))
```

```{r}
numzero.genes <- rowSums(adult.counts.keep==0)
table(numzero.genes > (ncol(adult.counts.keep)-20))
keep.genes <- numzero.genes < (ncol(adult.counts.keep)-20)
table(keep.genes)
adult.keep <- adult.counts.keep[keep.genes,]
dim(adult.keep)
ann.keep.adult <- ann.keep[keep.genes,]
```

## Limma analysis
```{r}
y.adult <- DGEList(adult.keep)

logcounts.adult <- normCounts(y.adult,log=TRUE,prior.count=0.5)

adult.bct <- factor(adult.integrated$Broad_celltype,
              levels=c("Cardiomyocytes","Fibroblast","Endothelial cells",
                       "Immune cells","Epicardial cells","Neurons",
                       "Smooth muscle cells"))

adult.integrated$Broad_celltype <- factor(adult.integrated$Broad_celltype,
              levels=c("Cardiomyocytes","Fibroblast","Endothelial cells",
                       "Immune cells","Epicardial cells","Neurons",
                       "Smooth muscle cells"))

design <- model.matrix(~0+adult.bct+adult.integrated$biorep)
colnames(design)[1:(length(levels(adult.bct)))] <- levels(adult.bct)

mycont <- matrix(0,ncol=length(levels(adult.bct)),nrow=length(levels(adult.bct)))
colnames(mycont)<-levels(adult.bct)
diag(mycont)<-1
mycont[upper.tri(mycont)]<- -1/(length(levels(adult.bct))-1)
mycont[lower.tri(mycont)]<- -1/(length(levels(adult.bct))-1)

# Fill out remaining rows with 0s
zero.rows <- matrix(0,ncol=length(levels(adult.bct)),nrow=(ncol(design)-length(levels(adult.bct))))
test <- rbind(mycont,zero.rows)


fit <- lmFit(logcounts.adult,design)
fit.cont <- contrasts.fit(fit,contrasts=test)
fit.cont <- eBayes(fit.cont,trend=TRUE,robust=TRUE)

fit.cont$genes <- ann.keep.adult

summary(decideTests(fit.cont))

treat <- treat(fit.cont,lfc=0.5)

dt <- decideTests(treat)
summary(dt)

```

```{r}
treat.adult <- treat
save(treat.adult,file="./output/RDataObjects/bct-treat-adult.RData")
```

```{r,fig.width=10,fig.height=10}
par(mfrow=c(3,3))
par(mar=c(5,5,2,2))
for(i in 1:ncol(mycont)){
  plotMD(treat,coef=i,status = dt[,i],hl.cex=0.5)
  abline(h=0,col=colours()[c(226)])
  lines(lowess(treat$Amean,treat$coefficients[,i]),lwd=1.5,col=4)
}
```

### Write out marker genes for each cluster

```{r eval=FALSE}
contnames <- colnames(mycont)

for(i in 1:length(contnames)){
  topsig <- topTreat(treat,coef=i,n=Inf,sort.by = "t")
  write.csv(topsig,file=paste("./output/ForPaper/BroadCellTypeMarkers/Adult-MarkerAnalysis/Adult-",contnames[i],".csv",sep=""))
}
```

```{r}
fdr <- apply(treat$p.value, 2, function(x) p.adjust(x, method="BH"))
output <- data.frame(treat$genes,LogFC=treat$coefficients,AveExp=treat$Amean,tstat=treat$t, pvalue=treat$p.value, fdr=fdr)
write.csv(output,file="./output/ForPaper/BroadCellTypeMarkers/Adult-MarkerAnalysis/AdultMarkerAnalysis.csv")
```

### DotPlot to visualise marker genes in adult 
```{r}
DefaultAssay(adult.integrated) <- "RNA"

sig.genes <- gene.label <- vector("list", length(contnames))
for(i in 1:length(sig.genes)){
  top <- topTreat(treat.adult,coef=i,n=Inf,sort.by="t")
  sig.genes[[i]] <- rownames(top)[top$logFC>0][1:10]
  gene.label[[i]] <- paste(rownames(top)[top$logFC>0][1:10],contnames[i],sep="-")
} 

csig <- unlist(sig.genes)
genes <- unlist(gene.label)

missing <- is.na(match(csig,rownames(adult.integrated)))

csig2 <- csig[!missing]

gene.cols <- rep(c(ggplotColors(7)),each=10)
gene.cols <- gene.cols[!missing]

d <- duplicated(csig2)
csig2 <- csig2[!d]
gene.cols <- gene.cols[!d]
```

```{r}
DotPlot(adult.integrated,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Adult/DotPlotMarkers.pdf",width=7,height=12)
DotPlot(young.integrated,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))
dev.off()
```


## Perform gene set testing on reactome sets

```{r}
c2.id <- ids2indices(Hs.c2,treat.adult$genes$ENTREZID)
reactome.id <-c2.id[grep("REACTOME",names(c2.id))]

reactome.cardio <- cameraPR(treat$t[,1],reactome.id)

for(i in 1:length(contnames)){
  write.csv(cameraPR(treat$t[,i],reactome.id),file=paste("./output/ForPaper/BroadCellTypeMarkers/Adult-MarkerAnalysis/Adult-reactome-",contnames[i],".csv",sep=""))
}
```


### Reactome figures - cardio
```{r}
cardio.camera <- cameraPR(treat$t[,1],reactome.id)
cardio.camera.up <- cardio.camera[cardio.camera[,2]=="Up",]

fibro.camera <- cameraPR(treat$t[,2],reactome.id)
fibro.camera.up <- fibro.camera[fibro.camera[,2]=="Up",]

endo.camera <- cameraPR(treat$t[,3],reactome.id)
endo.camera.up <- endo.camera[endo.camera[,2]=="Up",]

immune.camera <- cameraPR(treat$t[,4],reactome.id)
immune.camera.up <- immune.camera[immune.camera[,2]=="Up",]

epic.camera <- cameraPR(treat$t[,5],reactome.id)
epic.camera.up <- epic.camera[epic.camera[,2]=="Up",]

neuron.camera <- cameraPR(treat$t[,6],reactome.id)
neuron.camera.up <- neuron.camera[neuron.camera[,2]=="Up",]

smc.camera <- cameraPR(treat$t[,7],reactome.id)
smc.camera.up <- smc.camera[smc.camera[,2]=="Up",]

nsets <- 5
all.cam.adult <- rbind(cardio.camera.up[1:nsets,], fibro.camera.up[1:nsets,],
                       endo.camera.up[1:nsets,],immune.camera.up[1:nsets,],
                       epic.camera.up[1:nsets,],neuron.camera.up[1:nsets,],
                       smc.camera.up[1:nsets,])

scores <- -log10(all.cam.adult$PValue)
names(scores) <- rownames(all.cam.adult)
names(scores) <- gsub("REACTOME_","",names(scores))

par(mfrow=c(1,1))
par(mar=c(5,39,3,2))
barplot(scores[length(scores):1],horiz = T,las=2,col=rev(rep(ggplotColors(7),each=nsets)),cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5,xlim=c(0,80))
abline(v= -log10(0.05),lty=2)
title("Adult - reactome sets",cex.main=2)
legend("right",legend=levels(adult.integrated$Broad_celltype),fill=ggplotColors(7),cex=1.35,bty="n")
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Adult/adult-reactome-all-top5-barplot.pdf",width=13,height=6)
par(mfrow=c(1,1))
par(mar=c(5,39,3,2))
barplot(scores[length(scores):1],horiz = T,las=2,col=rev(rep(ggplotColors(7),each=3)),cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5,xlim=c(0,80))
abline(v= -log10(0.05),lty=2)
title("Adult - reactome sets",cex.main=2)
#legend("right",legend=levels(adult.integrated$Broad_celltype),fill=ggplotColors(7),cex=1.35,bty="n")
dev.off()
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/Adult/test-adult.pdf",width=19,height=11, onefile = FALSE)
plot.new()
grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 2)))

aggplot <- DotPlot(adult.integrated,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))

#Draw ggplot
pushViewport(viewport(layout.pos.col = 2))
print(aggplot, newpage = FALSE)
popViewport()

#Draw bsae plot
pushViewport(viewport(layout.pos.col = 1))
par(fig = gridFIG(), new = TRUE)
par(mar=c(10,39,0,1))
par(mgp=c(4,1,0))
barplot(scores[length(scores):1],horiz = T, las=2,col=rev(rep(ggplotColors(7),each=nsets)),cex.names=0.8,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
popViewport()

dev.off()
```


#  Broad cell type marker analysis combining all samples together

```{r}
heart <- readRDS(file="./output/RDataObjects/heartFYA.Rds")
```

```{r}
heart$Broad_celltype <- factor(heart$Broad_celltype,
              levels=c("Cardiomyocytes","Fibroblast","Endothelial cells",
                       "Immune cells","Epicardial cells","Neurons",
                       "Smooth muscle cells","Erythroid"))
heart$biorep <- factor(heart$biorep,levels=c("f1","f2","f3","y1","y2","y3","a1","a2","a3"))
table(heart$biorep,heart$Broad_celltype)
```
```{r}
m <- match(colnames(heart),colnames(all))
all.counts <- all[,m]
```

## Get gene annotation and perform filtering
```{r}
columns(org.Hs.eg.db)
ann <- AnnotationDbi:::select(org.Hs.eg.db,keys=rownames(all.counts),columns=c("SYMBOL","ENTREZID","ENSEMBL","GENENAME","CHR"),keytype = "SYMBOL")
m <- match(rownames(all.counts),ann$SYMBOL)
ann <- ann[m,]
table(ann$SYMBOL==rownames(all.counts))
```

```{r}
mito <- grep("mitochondrial",ann$GENENAME)
length(mito)
ribo <- grep("ribosomal",ann$GENENAME)
length(ribo)
missingEZID <- which(is.na(ann$ENTREZID))
length(missingEZID)
```

```{r}
chuck <- unique(c(mito,ribo,missingEZID))
length(chuck)
all.counts.keep <- all.counts[-chuck,]
ann.keep <- ann[-chuck,]
table(ann.keep$SYMBOL==rownames(all.counts.keep))
```

```{r}
numzero.genes <- rowSums(all.counts.keep==0)
table(numzero.genes > (ncol(all.counts.keep)-20))
keep.genes <- numzero.genes < (ncol(all.counts.keep)-20)
table(keep.genes)
all.keep <- all.counts.keep[keep.genes,]
dim(all.keep)
ann.keep.all <- ann.keep[keep.genes,]
```

## Limma analysis
```{r}
y.all <- DGEList(all.keep)

logcounts.all <- normCounts(y.all,log=TRUE,prior.count=0.5)

all.bct <- factor(heart$Broad_celltype,
              levels=c("Cardiomyocytes","Fibroblast","Endothelial cells",
                       "Immune cells","Epicardial cells","Neurons",
                       "Smooth muscle cells","Erythroid"))

design <- model.matrix(~0+all.bct+heart$biorep)
colnames(design)[1:(length(levels(all.bct)))] <- levels(all.bct)

mycont <- matrix(0,ncol=length(levels(all.bct)),nrow=length(levels(all.bct)))
colnames(mycont)<-levels(all.bct)
diag(mycont)<-1
mycont[upper.tri(mycont)]<- -1/(length(levels(all.bct))-1)
mycont[lower.tri(mycont)]<- -1/(length(levels(all.bct))-1)

# Fill out remaining rows with 0s
zero.rows <- matrix(0,ncol=length(levels(all.bct)),nrow=(ncol(design)-length(levels(all.bct))))
test <- rbind(mycont,zero.rows)


fit <- lmFit(logcounts.all,design)
fit.cont <- contrasts.fit(fit,contrasts=test)
fit.cont <- eBayes(fit.cont,trend=TRUE,robust=TRUE)

fit.cont$genes <- ann.keep.all

summary(decideTests(fit.cont))

treat <- treat(fit.cont,lfc=0.5)

dt <- decideTests(treat)
summary(dt)

```
```{r}
treat.all <- treat
save(treat.all,file="./output/RDataObjects/bct-treat-all.RData")
```

```{r,fig.width=10,fig.height=10}
par(mfrow=c(3,3))
par(mar=c(5,5,2,2))
for(i in 1:ncol(mycont)){
  plotMD(treat,coef=i,status = dt[,i],hl.cex=0.5)
  abline(h=0,col=colours()[c(226)])
  lines(lowess(treat$Amean,treat$coefficients[,i]),lwd=1.5,col=4)
}
```

### Write out marker genes for each cluster

```{r eval=FALSE}
contnames <- colnames(mycont)

for(i in 1:length(contnames)){
  topsig <- topTreat(treat,coef=i,n=Inf,sort.by = "t")
  write.csv(topsig,file=paste("./output/ForPaper/BroadCellTypeMarkers/All/All-",contnames[i],".csv",sep=""))
}
```

```{r}
fdr <- apply(treat$p.value, 2, function(x) p.adjust(x, method="BH"))
output <- data.frame(treat$genes,LogFC=treat$coefficients,AveExp=treat$Amean,tstat=treat$t, pvalue=treat$p.value, fdr=fdr)
write.csv(output,file="./output/ForPaper/BroadCellTypeMarkers/All/All-MarkerAnalysis.csv")
```

### DotPlot to visualise marker genes in adult 

```{r}
DefaultAssay(heart) <- "RNA"

sig.genes <- gene.label <- vector("list", length(contnames))
for(i in 1:length(sig.genes)){
  top <- topTreat(treat.all,coef=i,n=Inf,sort.by="t")
  sig.genes[[i]] <- rownames(top)[top$logFC>0][1:10]
  gene.label[[i]] <- paste(rownames(top)[top$logFC>0][1:10],contnames[i],sep="-")
} 

csig <- unlist(sig.genes)
genes <- unlist(gene.label)

missing <- is.na(match(csig,rownames(heart)))

csig2 <- csig[!missing]

gene.cols <- rep(c(ggplotColors(7),"grey"),each=10)
gene.cols <- gene.cols[!missing]

d <- duplicated(csig2)
csig2 <- csig2[!d]
gene.cols <- gene.cols[!d]
```

```{r}
DotPlot(heart,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))
```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/All/All-DotPlotMarkers.pdf",width=7,height=12)
DotPlot(heart,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))
dev.off()
```

```{r}
# Splitting by group and using Evangelyn's color scheme
DotPlot(heart,features=unique(csig2),group.by="Broad_celltype",split.by="orig.ident",cols = c("hotpink1","mediumpurple1","deepskyblue"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))
```


## Perform gene set testing on reactome sets

```{r}
c2.id <- ids2indices(Hs.c2,treat.all$genes$ENTREZID)
reactome.id <-c2.id[grep("REACTOME",names(c2.id))]

reactome.cardio <- cameraPR(treat.all$t[,1],reactome.id)

for(i in 1:length(contnames)){
  write.csv(cameraPR(treat.all$t[,i],reactome.id),file=paste("./output/ForPaper/BroadCellTypeMarkers/All/All-reactome-",contnames[i],".csv",sep=""))
}
```


### Reactome figures - cardio

```{r}
cardio.camera <- cameraPR(treat.all$t[,1],reactome.id)
cardio.camera.up <- cardio.camera[cardio.camera[,2]=="Up",]

fibro.camera <- cameraPR(treat.all$t[,2],reactome.id)
fibro.camera.up <- fibro.camera[fibro.camera[,2]=="Up",]

endo.camera <- cameraPR(treat.all$t[,3],reactome.id)
endo.camera.up <- endo.camera[endo.camera[,2]=="Up",]

immune.camera <- cameraPR(treat.all$t[,4],reactome.id)
immune.camera.up <- immune.camera[immune.camera[,2]=="Up",]

epic.camera <- cameraPR(treat.all$t[,5],reactome.id)
epic.camera.up <- epic.camera[epic.camera[,2]=="Up",]

neuron.camera <- cameraPR(treat.all$t[,6],reactome.id)
neuron.camera.up <- neuron.camera[neuron.camera[,2]=="Up",]

smc.camera <- cameraPR(treat.all$t[,7],reactome.id)
smc.camera.up <- smc.camera[smc.camera[,2]=="Up",]

eryth.camera <- cameraPR(treat.all$t[,8],reactome.id)
eryth.camera.up <- eryth.camera[eryth.camera[,2]=="Up",]

nsets <- 5
all.cam <- rbind(cardio.camera.up[1:nsets,], fibro.camera.up[1:nsets,],
                       endo.camera.up[1:nsets,],immune.camera.up[1:nsets,],
                       epic.camera.up[1:nsets,],neuron.camera.up[1:nsets,],
                       smc.camera.up[1:nsets,],eryth.camera.up[1:nsets,])

scores <- -log10(all.cam$PValue)
names(scores) <- rownames(all.cam)
names(scores) <- gsub("REACTOME_","",names(scores))


par(mfrow=c(1,1))
par(mar=c(5,41,3,2))
barplot(scores[length(scores):1],horiz = T,las=2,col=rev(rep(c(ggplotColors(7),"grey"),each=nsets)),cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)

```

```{r}
pdf(file="./output/ForPaper/BroadCellTypeMarkers/Figs/All/test-all.pdf",width=20,height=11, onefile = FALSE)
plot.new()
grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 2)))

aggplot <- DotPlot(heart,features=unique(csig2),group.by="Broad_celltype",cols = c("lightgrey", "red"))+RotatedAxis() + FontSize(y.text = 12, x.text=20) + labs(y=element_blank(),x=element_blank()) + coord_flip() + theme(axis.text.y = element_text(color=rev(gene.cols)))

#Draw ggplot
pushViewport(viewport(layout.pos.col = 2))
print(aggplot, newpage = FALSE)
popViewport()

bar.cols <- rev(rep(c(ggplotColors(7),"grey"),each=nsets))
        
#Draw bsae plot
pushViewport(viewport(layout.pos.col = 1))
par(fig = gridFIG(), new = TRUE)
par(mar=c(10,41,0,1))
par(mgp=c(4,1,0))
barplot(scores[length(scores):1],horiz = T,las=2,col=rev(rep(c(ggplotColors(7),"grey"),each=nsets)),cex.names=0.9,
        cex.axis = 1.5,xlab="-log10(PValue)",cex.lab=1.5)
abline(v= -log10(0.05),lty=2)
popViewport()

dev.off()
```


## Down-sampling the data

```{r}
cell_info <- data.frame(CellID = colnames(heart),Sex = heart$sex, Sample = heart$biorep, Group = heart$orig.ident, CellType = heart$Broad_celltype, stringsAsFactors = FALSE)
sample_cells <- sample(colnames(all.counts),size=20000)
sampled.counts <- all.counts[,sample_cells]
cell_info_sampled <- cell_info[sample_cells,]
save(sampled.counts,cell_info_sampled,file="/group/bioi1/belinda/SingleCell/humanHeart/sampled_data20K.Rdata")

```


